-- ðŸ—ƒï¸ Ð—ÐÐ”ÐÐÐ˜Ð• 1: Ð¡ÐžÐ—Ð”ÐÐÐ˜Ð• Ð‘ÐÐ—Ð« Ð”ÐÐÐÐ«Ð¥ Ð˜ Ð¢ÐÐ‘Ð›Ð˜Ð¦
-- Ð¦ÐµÐ»ÑŒ: ÐÐ°ÑƒÑ‡Ð¸Ñ‚ÑŒÑÑ ÑÐ¾Ð·Ð´Ð°Ð²Ð°Ñ‚ÑŒ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹ Ñ Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð½Ñ‹Ð¼Ð¸ Ð¾Ð³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸ÑÐ¼Ð¸.

-- 1.1. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ… "CompanyDB"
-- Ð•ÑÐ»Ð¸ Ð±Ð°Ð·Ð° ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ - ÑƒÐ´Ð°Ð»ÑÐµÐ¼ ÐµÑ‘
USE master;
GO

IF DB_ID('CompanyDB') IS NOT NULL
    DROP DATABASE CompanyDB;
GO

CREATE DATABASE CompanyDB;
GO

-- ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ð½Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð½ÑƒÑŽ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…
USE CompanyDB;
GO

-- 1.2. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñƒ Departments (ÐžÑ‚Ð´ÐµÐ»Ñ‹)
CREATE TABLE Departments (
    DepartmentID INT IDENTITY(1,1) PRIMARY KEY,
    DepartmentName NVARCHAR(50) NOT NULL,
    Location NVARCHAR(100) NULL,
    Budget DECIMAL(15,2) DEFAULT 0.00,
    CreatedDate DATETIME DEFAULT GETDATE()
);
GO

CREATE TABLE Employees (
    EmployeeID INT IDENTITY(1,1) PRIMARY KEY,
    FirstName NVARCHAR(50) NOT NULL,
    LastName NVARCHAR(50) NOT NULL,
    Email NVARCHAR(100) UNIQUE NOT NULL,
    Phone NVARCHAR(20) NULL, -- Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾: Ñ€Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÐ¼ NULL Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ
    HireDate DATE NOT NULL,
    Salary DECIMAL(10,2) CHECK (Salary >= 0),
    DepartmentID INT NULL,
    IsActive BIT DEFAULT 1,
    
    CONSTRAINT FK_Employees_Departments 
        FOREIGN KEY (DepartmentID) 
        REFERENCES Departments(DepartmentID)
        ON DELETE SET NULL
);
GO

CREATE TABLE Projects (
    ProjectID INT IDENTITY(1,1) PRIMARY KEY,
    ProjectName NVARCHAR(100) NOT NULL,
    StartDate DATE NOT NULL,
    EndDate DATE NULL,
    Budget DECIMAL(15,2) NULL,
    Status NVARCHAR(20) DEFAULT 'Active' 
        CHECK (Status IN ('Active', 'Completed', 'On Hold', 'Cancelled'))
);
GO

SELECT 
    TABLE_NAME,
    TABLE_TYPE
FROM INFORMATION_SCHEMA.TABLES 
WHERE TABLE_TYPE = 'BASE TABLE';


INSERT INTO Departments (DepartmentName, Location, Budget)
VALUES
    ('IT', '3 ÑÑ‚Ð°Ð¶', 500000.00),
    ('HR', '2 ÑÑ‚Ð°Ð¶', 250000.00),
    ('Finance', '1 ÑÑ‚Ð°Ð¶', 400000.00),
    ('Marketing', '4 ÑÑ‚Ð°Ð¶', 350000.00),
    ('Sales', '5 ÑÑ‚Ð°Ð¶', 600000.00);

INSERT INTO Employees (FirstName, LastName, Email, Phone, HireDate, Salary, DepartmentID)
VALUES
    ('Ð˜Ð²Ð°Ð½', 'Ð˜Ð²Ð°Ð½Ð¾Ð²', 'ivanov@company.com', '+7(999)123-45-67', '2020-01-15', 75000.00, 1),
    ('ÐœÐ°Ñ€Ð¸Ñ', 'ÐŸÐµÑ‚Ñ€Ð¾Ð²Ð°', 'petrova@company.com', '+7(999)234-56-78', '2019-03-10', 82000.00, 2),
    ('ÐÐ»ÐµÐºÑÐµÐ¹', 'Ð¡Ð¸Ð´Ð¾Ñ€Ð¾Ð²', 'sidorov@company.com', '+7(999)345-67-89', '2021-05-20', 68000.00, 1),
    ('ÐžÐ»ÑŒÐ³Ð°', 'ÐšÑƒÐ·Ð½ÐµÑ†Ð¾Ð²Ð°', 'kuznetsova@company.com', NULL, '2018-11-05', 95000.00, 3), -- Ð¢ÐµÐ¿ÐµÑ€ÑŒ NULL Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½
    ('Ð”Ð¼Ð¸Ñ‚Ñ€Ð¸Ð¹', 'Ð¡Ð¼Ð¸Ñ€Ð½Ð¾Ð²', 'smirnov@company.com', '+7(999)456-78-90', '2022-02-28', 55000.00, 5),
    ('Ð•ÐºÐ°Ñ‚ÐµÑ€Ð¸Ð½Ð°', 'Ð’Ð°ÑÐ¸Ð»ÑŒÐµÐ²Ð°', 'vasilieva@company.com', '+7(999)567-89-01', '2020-07-15', 72000.00, 4),
    ('Ð¡ÐµÑ€Ð³ÐµÐ¹', 'ÐŸÐ¾Ð¿Ð¾Ð²', 'popov@company.com', NULL, '2023-01-10', 48000.00, NULL); -- Ð¢ÐµÐ¿ÐµÑ€ÑŒ NULL Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½

INSERT INTO Projects (ProjectName, StartDate, EndDate, Budget, Status)
VALUES
    ('Ð Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð½Ð¾Ð²Ð¾Ð³Ð¾ ÑÐ°Ð¹Ñ‚Ð°', '2023-01-15', '2023-06-30', 200000.00, 'Active'),
    ('ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð½Ð¾ÑÑ‚Ð¸', '2023-02-01', '2023-08-15', 150000.00, 'Active'),
    ('Ð ÐµÐ±Ñ€ÐµÐ½Ð´Ð¸Ð½Ð³ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸', '2022-11-01', '2023-03-31', 300000.00, 'Completed'),
    ('Ð’Ð½ÐµÐ´Ñ€ÐµÐ½Ð¸Ðµ CRM ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹', '2023-03-01', NULL, 250000.00, 'On Hold'),
    ('Ð˜ÑÑÐ»ÐµÐ´Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ€Ñ‹Ð½ÐºÐ°', '2023-04-10', '2023-05-31', 80000.00, 'Active');

SELECT 'Departments' AS TableName, COUNT(*) AS [RowCount] FROM Departments
UNION ALL
SELECT 'Employees', COUNT(*) FROM Employees
UNION ALL
SELECT 'Projects', COUNT(*) FROM Projects;



SELECT * FROM Employees;

SELECT 
    FirstName,
    LastName, 
    Salary
FROM Employees;

SELECT 
    FirstName + ' ' + LastName AS FullName,
    Salary,
    HireDate
FROM Employees
WHERE Salary > 70000
ORDER BY Salary DESC;

SELECT 
    e.FirstName,
    e.LastName,
    e.Salary,
    d.DepartmentName
FROM Employees e
INNER JOIN Departments d ON e.DepartmentID = d.DepartmentID
WHERE d.DepartmentName = 'IT';

SELECT 
    d.DepartmentName,
    COUNT(e.EmployeeID) AS EmployeeCount,
    AVG(e.Salary) AS AverageSalary
FROM Departments d
LEFT JOIN Employees e ON d.DepartmentID = e.DepartmentID
GROUP BY d.DepartmentName
ORDER BY EmployeeCount DESC;

SELECT 
    ProjectName,
    StartDate,
    EndDate,
    Budget,
    Status
FROM Projects
WHERE Status = 'Active' AND EndDate IS NOT NULL;


UPDATE Employees
SET Salary = Salary * 1.10
WHERE DepartmentID = (SELECT DepartmentID FROM Departments WHERE DepartmentName = 'IT');

SELECT * FROM Employees WHERE DepartmentID = 1;

UPDATE Projects
SET Status = 'Completed', EndDate = GETDATE()
WHERE ProjectName = 'Ð ÐµÐ±Ñ€ÐµÐ½Ð´Ð¸Ð½Ð³ ÐºÐ¾Ð¼Ð¿Ð°Ð½Ð¸Ð¸' AND Status = 'Active';

UPDATE Employees
SET DepartmentID = (SELECT DepartmentID FROM Departments WHERE DepartmentName = 'Marketing')
WHERE DepartmentID IS NULL;

UPDATE Departments
SET Budget = Budget + 50000.00
WHERE DepartmentName = 'Sales';

UPDATE Employees
SET Email = 'ivanov.new@company.com'
WHERE FirstName = 'Ð˜Ð²Ð°Ð½' AND LastName = 'Ð˜Ð²Ð°Ð½Ð¾Ð²';

UPDATE Employees
SET DepartmentID = (SELECT DepartmentID FROM Departments WHERE DepartmentName = 'Finance')
WHERE FirstName = 'ÐœÐ°Ñ€Ð¸Ñ' AND LastName = 'ÐŸÐµÑ‚Ñ€Ð¾Ð²Ð°';


DELETE FROM Projects
WHERE Status = 'Cancelled';

SELECT * FROM Employees 
WHERE FirstName = 'Ð¡ÐµÑ€Ð³ÐµÐ¹' AND LastName = 'ÐŸÐ¾Ð¿Ð¾Ð²';

DELETE FROM Employees
WHERE FirstName = 'Ð¡ÐµÑ€Ð³ÐµÐ¹' AND LastName = 'ÐŸÐ¾Ð¿ov';

BEGIN TRY
    DELETE FROM Departments 
    WHERE DepartmentName = 'HR';
END TRY
BEGIN CATCH
    PRINT 'ÐÐµÐ»ÑŒÐ·Ñ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¾Ñ‚Ð´ÐµÐ», Ñ‚Ð°Ðº ÐºÐ°Ðº Ð² Ð½ÐµÐ¼ ÐµÑÑ‚ÑŒ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¸!';
END CATCH;

DELETE FROM Projects
WHERE Status = 'Completed';

UPDATE Employees SET IsActive = 0 WHERE EmployeeID = 5;
DELETE FROM Employees WHERE IsActive = 0;

SELECT 
    (SELECT COUNT(*) FROM Employees) AS EmployeesCount,
    (SELECT COUNT(*) FROM Departments) AS DepartmentsCount,
    (SELECT COUNT(*) FROM Projects) AS ProjectsCount;


BEGIN TRANSACTION;

INSERT INTO Departments (DepartmentName, Location, Budget)
VALUES ('Research & Development', '6 ÑÑ‚Ð°Ð¶', 450000.00);

DECLARE @NewDeptID INT = SCOPE_IDENTITY();

INSERT INTO Employees (FirstName, LastName, Email, Phone, HireDate, Salary, DepartmentID)
VALUES ('ÐÐ½Ð½Ð°', 'ÐÐ¾Ð²Ð¸ÐºÐ¾Ð²Ð°', 'novikova@company.com', '+7(999)678-90-12', GETDATE(), 78000.00, @NewDeptID);

COMMIT TRANSACTION;

UPDATE Employees
SET Salary = 
    CASE 
        WHEN DepartmentID = 1 THEN Salary * 1.15 -- IT +15%
        WHEN DepartmentID = 5 THEN Salary * 1.10 -- Sales +10%
        ELSE Salary * 1.05 -- Ð’ÑÐµ Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ +5%
    END;

SELECT DepartmentID 
INTO #DeptsToDelete
FROM Departments 
WHERE DepartmentName IN ('Temp Department', 'Old Department');

DELETE FROM Employees 
WHERE DepartmentID IN (SELECT DepartmentID FROM #DeptsToDelete);

DELETE FROM Departments 
WHERE DepartmentID IN (SELECT DepartmentID FROM #DeptsToDelete);

DROP TABLE #DeptsToDelete;

SELECT *
INTO ProjectsArchive
FROM Projects
WHERE Status = 'Completed';

UPDATE Projects
SET 
    Status = 'On Hold',
    Budget = Budget * 0.9 -- Ð£Ð¼ÐµÐ½ÑŒÑˆÐ°ÐµÐ¼ Ð±ÑŽÐ´Ð¶ÐµÑ‚ Ð½Ð° 10%
WHERE EndDate IS NULL AND DATEDIFF(MONTH, StartDate, GETDATE()) > 6;

SELECT 
    'Employees' AS TableName, 
    COUNT(*) AS RecordCount 
FROM Employees
UNION ALL
SELECT 'Departments', COUNT(*) FROM Departments
UNION ALL
SELECT 'Projects', COUNT(*) FROM Projects
UNION ALL
SELECT 'ProjectsArchive', COUNT(*) FROM ProjectsArchive;
